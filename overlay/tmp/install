#!/usr/bin/nu

use bf

# Setup and install getssl and depdencies
def main [] {
    # get nginx version and install dependencies
    cd /tmp
    let nginx_version = bf fs read NGINX_BUILD
    bf write $"Installing dependencies for getssl."
    bf pkg install [
        "bash"
        "curl"
        $"nginx-mod-http-set-misc=($nginx_version)"
        "openssl"
    ]

    # download getssl script and make executable
    let getssl_version = bf fs read GETSSL_VERSION
    let getssl_url = $"https://raw.githubusercontent.com/srvrco/getssl/v($getssl_version)/getssl"
    let getssl_exe = "/usr/bin/getssl"
    http get $getssl_url | save --raw $getssl_exe
    ^chmod +x $getssl_exe

    # create and link directories
    ^ln -s /sites /etc/nginx/sites
    ^mkdir -p /ssl/certs

    # add bf-nginx-proxy module to config
    bf config use bf/nginx/proxy
}
