{{ if eq (getenv "DOMAIN_NGXCONF") "" }}#======================================================================================================================
# WARNING: This file is generated. Do not make changes to this file.
# Changes will be overwritten the next time the container is started.
#
# To add server names or aliases please use /ssl/conf.sh.
#
# If you need a fully custom configuration then add the following to /ssl/conf.sh:
#   NGXCONF["{{ getenv "DOMAIN_NAME" }}"]="custom"
# This will stop this file being generated next time the container is started.
#
# Copyright (c) 2021 Ben Green <https://bcgdesign.com>
#======================================================================================================================

{{ end }}server {
    server_name                         {{ getenv "SERVER_NAMES" }};
    listen                              80{{ if eq (getenv "IS_DEFAULT") "1" }} default_server{{ end }};
    listen                              [::]:80{{ if eq (getenv "IS_DEFAULT") "1" }} default_server{{ end }};

    location ^~ /{{ getenv "ACME_CHALLENGE" }} {
        allow                           all;
        root                            {{ getenv "WWW" }};
    }

    location / {
        {{ if eq (getenv "SSL_REDIRECT_INSECURE") "1" }}{{ range ( (getenv "SERVER_NAMES") | strings.Split " " ) }}{{ if . }}
        if ($host = {{ . }}) {
            return                      301 https://{{ if eq (getenv "SSL_REDIRECT_TO_CANONICAL") "1" }}{{ getenv "DOMAIN_NAME" }}{{ else }}$host{{ end }}$request_uri;
        }
        {{ end }}{{ end }}{{ end }}
        return                          204;
    }
}

server {
    server_name                         {{ getenv "SERVER_NAMES" }};
    listen                              443 ssl http2{{ if eq (getenv "IS_DEFAULT") "1" }} default_server{{ end }};
    listen                              [::]:443 ssl http2{{ if eq (getenv "IS_DEFAULT") "1" }} default_server{{ end }};

    add_header                          X-Clacks-Overhead "GNU Terry Pratchett";

    {{ if eq (getenv "SSL_REDIRECT_TO_CANONICAL") "1" }}if ($host != {{ getenv "DOMAIN_NAME" }}) {
        return                          301 https://{{ getenv "DOMAIN_NAME" }}$request_uri;
    }{{ end }}

    location / {
        proxy_pass                      {{ getenv "UPSTREAM" }};
        include                         helpers/proxy-params.conf;
        include                         helpers/proxy-secure-headers.conf;
        error_page                      502 /maintenance.html;
        include                         {{ getenv "CUSTOM_CONF" }}/*.conf;
    }

    include                             helpers/proxy-maintenance.conf;

    ssl_certificate                     {{ getenv "SSL_CERTS" }}/{{ getenv "DOMAIN_NAME" }}/fullchain.crt;
    ssl_certificate_key                 {{ getenv "SSL_CERTS" }}/{{ getenv "DOMAIN_NAME" }}.key;
    ssl_trusted_certificate             {{ getenv "SSL_CERTS" }}/{{ getenv "DOMAIN_NAME" }}/chain.crt;
    ssl_dhparam                         {{ getenv "SSL_DHPARAM" }};
}
