#!/usr/bin/with-contenv bash

#======================================================================================================================
# Run checks and include ssl functions
#======================================================================================================================

source ${INC}/check.sh
source ${INC}/setup-ssl.sh


#======================================================================================================================
# Request certificates for all domains
#   -U  stop upgrade checks
#   -w  set working directory
#======================================================================================================================

request() {
    /etc/ssl/getssl -U -w "${SSL_CERTS}" "${1}"
    create_pem "${1}"
}


#======================================================================================================================
# Get certificate for the proxy server base domain
#======================================================================================================================

bcg-echo "Requesting proxy server certificate..."
request "${PROXY_URI}"
bcg-done


#======================================================================================================================
# Get certificates for all registered domains
#======================================================================================================================

bcg-echo "Requesting domain certificates..."
for DN in "${!DOMAINS[@]}" ; do
    bcg-echo " .. ${DN}"
    request "${DN}"
done
bcg-done
