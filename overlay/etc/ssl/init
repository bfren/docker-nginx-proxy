#!/usr/bin/with-contenv bash

set -euo pipefail


#======================================================================================================================
# Run checks
#======================================================================================================================

source ${INC}/check.sh


#======================================================================================================================
# Require source files
#======================================================================================================================

source ${INC}/replace.sh
source ${INC}/setup-global.sh
source ${INC}/setup-nginx.sh
source ${INC}/setup-ssl.sh


#======================================================================================================================
# Set up global SSL configuration
#======================================================================================================================

_echo "Setting up getssl..."
setup_global
_done


#======================================================================================================================
# Set up Nginx and SSL for each primary domain
#======================================================================================================================

_echo "Setting up domains..."
for DN in "${!DOMAINS[@]}" ; do

    UP=${DOMAINS[${DN}]}     # upstream server
    AL=(${ALIASES[${DN}]})   # domain aliases
    CF=${NGXCONF[${DN}]}     # domain Nginx configuration default / custom

    _echo " .. ${DN}"

    _echo "  . Nginx..."
    setup_nginx ${DN} ${UP} AL ${CF}

    _echo "  . SSL..."
    setup_ssl ${DN} AL

    _ok "  . done."

done
_ok "Domains set up."
